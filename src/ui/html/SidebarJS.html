<script>
  /**
   * Sidebar client-side JavaScript
   */

  // Status display helpers
  function showStatus(message, type) {
    const statusArea = document.getElementById('status-area');
    statusArea.textContent = message;
    statusArea.className = 'status-area ' + type;

    if (type !== 'loading') {
      setTimeout(() => {
        statusArea.className = 'status-area';
      }, 3000);
    }
  }

  function showLoading(message) {
    showStatus(message || 'Loading...', 'loading');
  }

  function showSuccess(message) {
    showStatus(message, 'success');
  }

  function showError(message) {
    showStatus(message, 'error');
  }

  function clearStatus() {
    const statusArea = document.getElementById('status-area');
    statusArea.className = 'status-area';
  }

  // Context management
  function refreshContext() {
    showLoading('Refreshing...');
    google.script.run
      .withSuccessHandler(updateContext)
      .withFailureHandler(handleError)
      .getSidebarContext();
  }

  function updateContext(result) {
    clearStatus();
    document.getElementById('context-label').textContent = result.label;

    // Hide all action sections
    document.getElementById('no-context').style.display = 'none';
    document.getElementById('borrowers-actions').style.display = 'none';
    document.getElementById('media-actions').style.display = 'none';
    document.getElementById('loans-actions').style.display = 'none';

    // Show appropriate section
    if (result.context === 'Borrowers') {
      document.getElementById('borrowers-actions').style.display = 'block';
    } else if (result.context === 'Media') {
      document.getElementById('media-actions').style.display = 'block';
    } else if (result.context === 'Loans') {
      document.getElementById('loans-actions').style.display = 'block';
    } else {
      document.getElementById('no-context').style.display = 'block';
    }
  }

  function handleError(error) {
    showError(error.message || 'An error occurred');
  }

  // Borrower actions
  function addBorrower() {
    showLoading('Opening form...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showAddBorrowerDialog();
  }

  function editSelectedBorrower() {
    showLoading('Loading borrower...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showEditBorrowerDialog();
  }

  function searchBorrowers() {
    showLoading('Opening search...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showSearchBorrowersDialog();
  }

  function viewBorrowerLoans() {
    showLoading('Loading loans...');
    google.script.run
      .withSuccessHandler(showSuccess)
      .withFailureHandler(handleError)
      .viewBorrowerLoans();
  }

  function suspendBorrower() {
    if (confirm('Are you sure you want to suspend this borrower?')) {
      showLoading('Suspending borrower...');
      google.script.run
        .withSuccessHandler(function() { showSuccess('Borrower suspended'); })
        .withFailureHandler(handleError)
        .suspendSelectedBorrower();
    }
  }

  // Media actions
  function addMedia() {
    showLoading('Opening form...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showAddMediaDialog();
  }

  function editSelectedMedia() {
    showLoading('Loading media...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showEditMediaDialog();
  }

  function searchMedia() {
    showLoading('Opening search...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showSearchMediaDialog();
  }

  function checkAvailability() {
    showLoading('Checking...');
    google.script.run
      .withSuccessHandler(function(result) { showSuccess(result); })
      .withFailureHandler(handleError)
      .checkMediaAvailability();
  }

  function markAsLost() {
    if (confirm('Are you sure you want to mark this item as lost?')) {
      showLoading('Updating status...');
      google.script.run
        .withSuccessHandler(function() { showSuccess('Marked as lost'); })
        .withFailureHandler(handleError)
        .markSelectedMediaAsLost();
    }
  }

  // Loan actions
  function newCheckout() {
    showLoading('Opening checkout form...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showCheckoutDialog();
  }

  function processReturn() {
    showLoading('Processing return...');
    google.script.run
      .withSuccessHandler(function() { showSuccess('Return processed'); })
      .withFailureHandler(handleError)
      .processSelectedReturn();
  }

  function extendLoan() {
    showLoading('Opening extension form...');
    google.script.run
      .withSuccessHandler(clearStatus)
      .withFailureHandler(handleError)
      .showExtendLoanDialog();
  }

  function showOverdue() {
    showLoading('Loading overdue loans...');
    google.script.run
      .withSuccessHandler(function(count) { showSuccess(count + ' overdue loans found'); })
      .withFailureHandler(handleError)
      .filterOverdueLoans();
  }

  function showActiveLoans() {
    showLoading('Loading active loans...');
    google.script.run
      .withSuccessHandler(function(count) { showSuccess(count + ' active loans'); })
      .withFailureHandler(handleError)
      .filterActiveLoans();
  }

  // Auto-refresh context periodically (every 2 seconds when focused)
  let contextRefreshInterval;

  function startContextRefresh() {
    if (!contextRefreshInterval) {
      contextRefreshInterval = setInterval(refreshContext, 2000);
    }
  }

  function stopContextRefresh() {
    if (contextRefreshInterval) {
      clearInterval(contextRefreshInterval);
      contextRefreshInterval = null;
    }
  }

  // Start/stop refresh based on window focus
  window.addEventListener('focus', startContextRefresh);
  window.addEventListener('blur', stopContextRefresh);

  // Initial context load
  document.addEventListener('DOMContentLoaded', function() {
    refreshContext();
    startContextRefresh();
  });
</script>
