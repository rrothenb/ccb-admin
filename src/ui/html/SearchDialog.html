<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('Styles'); ?>
    <style>
      .search-results {
        max-height: 250px;
        overflow-y: auto;
        margin-top: 16px;
      }
      .result-item {
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .result-item:hover {
        background-color: #f3f4f6;
        border-color: #2563eb;
      }
      .result-item .primary {
        font-weight: 500;
        margin-bottom: 4px;
      }
      .result-item .secondary {
        font-size: 13px;
        color: #6b7280;
      }
      .no-results {
        text-align: center;
        color: #6b7280;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar-container">
      <div class="form-group">
        <label for="search-query">Search</label>
        <input type="text" id="search-query" placeholder="Enter search term..." autofocus>
      </div>

      <button class="btn btn-primary" onclick="performSearch()">Search</button>

      <div id="search-results" class="search-results"></div>

      <div id="status-area" class="status-area"></div>
    </div>

    <script>
      function showStatus(message, type) {
        const statusArea = document.getElementById('status-area');
        statusArea.textContent = message;
        statusArea.className = 'status-area ' + type;
      }

      function performSearch() {
        const query = document.getElementById('search-query').value.trim();
        if (!query) {
          showStatus('Please enter a search term', 'error');
          return;
        }

        showStatus('Searching...', 'loading');

        // Determine which search to perform based on current context
        google.script.run
          .withSuccessHandler(function(context) {
            if (context.context === 'Borrowers') {
              google.script.run
                .withSuccessHandler(displayResults)
                .withFailureHandler(handleError)
                .searchBorrowers(query);
            } else if (context.context === 'Media') {
              google.script.run
                .withSuccessHandler(displayResults)
                .withFailureHandler(handleError)
                .searchMedia(query);
            } else {
              showStatus('Please select a sheet first', 'error');
            }
          })
          .getSidebarContext();
      }

      function displayResults(results) {
        const container = document.getElementById('search-results');
        document.getElementById('status-area').className = 'status-area';

        if (!results || results.length === 0) {
          container.innerHTML = '<div class="no-results">No results found</div>';
          return;
        }

        container.innerHTML = results.map(function(item) {
          // Handle both borrower and media results
          const primary = item.name || item.title;
          const secondary = item.email || (item.author + ' (' + item.type + ')');

          return '<div class="result-item" onclick="selectResult(\'' + item.id + '\')">' +
            '<div class="primary">' + primary + '</div>' +
            '<div class="secondary">' + secondary + '</div>' +
          '</div>';
        }).join('');
      }

      function selectResult(id) {
        // Navigate to the row in the spreadsheet
        google.script.host.close();
        // TODO: Implement row selection
      }

      function handleError(error) {
        showStatus(error.message || 'Search failed', 'error');
      }

      // Allow Enter key to trigger search
      document.getElementById('search-query').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    </script>
  </body>
</html>
